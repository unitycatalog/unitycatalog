name: Generated Code Check

# This workflow verifies that all code generated by 'build/sbt generate' is already checked in.
# It runs the generate command and fails if any tracked files are modified or new files are created.
# This ensures that developers run 'build/sbt generate' and commit the results before pushing.

on:
  push:
    branches: [ "main" ]
    paths:
      # OpenAPI spec files that trigger code generation
      - 'api/all.yaml'
      - 'api/control.yaml'
      - 'api/.openapi-generator-ignore'
      # Build configuration files
      - 'build.sbt'
      - 'project/**'
      - 'clients/python/build/.openapi-generator-ignore'
      # This workflow file itself
      - '.github/workflows/generated-code-check.yml'
  pull_request:
    paths:
      # OpenAPI spec files that trigger code generation
      - 'api/all.yaml'
      - 'api/control.yaml'
      - 'api/.openapi-generator-ignore'
      # Build configuration files
      - 'build.sbt'
      - 'project/**'
      - 'clients/python/build/.openapi-generator-ignore'
      # This workflow file itself
      - '.github/workflows/generated-code-check.yml'

permissions:
  contents: read

jobs:
  check-generated-code:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Run code generation
        run: |
          echo "Running 'build/sbt generate' to regenerate all code..."
          build/sbt generate

      - name: Check for uncommitted changes
        run: |
          echo "Checking for changes in tracked files..."
          
          # Check if there are any changes after generation
          if ! git diff --exit-code; then
            echo ""
            echo "=========================================="
            echo "❌ ERROR: Generated code is out of sync"
            echo "=========================================="
            echo ""
            echo "Running 'build/sbt generate' caused changes in tracked files."
            echo "This means the generated code checked into the repository is outdated."
            echo ""
            echo "Files with changes:"
            git diff --name-only
            echo ""
            echo "Detailed diff:"
            git diff
            echo ""
            echo "To fix this issue:"
            echo "  1. Run 'build/sbt generate' locally"
            echo "  2. Review the changes"
            echo "  3. Commit the updated generated files"
            echo ""
            exit 1
          fi
          
          # Check for untracked files that were generated (excluding target/ and known temp dirs)
          UNTRACKED=$(git ls-files --others --exclude-standard | grep -v "^target/" || true)
          if [ -n "$UNTRACKED" ]; then
            echo ""
            echo "=========================================="
            echo "⚠️  WARNING: New untracked files detected"
            echo "=========================================="
            echo ""
            echo "Running 'build/sbt generate' created new untracked files:"
            echo "$UNTRACKED"
            echo ""
            echo "If these files should be tracked, please add and commit them."
            echo "If they should be ignored, update .gitignore."
            echo ""
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "✅ SUCCESS: Generated code is up to date"
          echo "=========================================="
          echo ""
          echo "All generated code is properly checked in and synchronized."
