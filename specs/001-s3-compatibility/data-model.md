# Data Model: S3-Compatible Storage Support

**Feature**: 001-s3-compatibility  
**Date**: 2025-11-04

## Overview

This feature extends existing Unity Catalog data models to support S3-compatible storage services. No new database entities are created; only Java configuration classes are extended.

## Modified Entities

### S3StorageConfig

**Purpose**: Configuration holder for S3 or S3-compatible storage bucket settings.

**Location**: `server/src/main/java/io/unitycatalog/server/service/credential/aws/S3StorageConfig.java`

**Type**: Java class (Lombok @Builder)

**Attributes**:

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| bucketPath | String | Yes | - | S3 bucket path (e.g., `s3://my-bucket`) |
| region | String | Yes | - | AWS region or region identifier for S3-compatible service |
| awsRoleArn | String | Conditional | null | AWS IAM role ARN or equivalent for S3-compatible service |
| accessKey | String | Conditional | null | Static access key (if not using STS) |
| secretKey | String | Conditional | null | Static secret key (if not using STS) |
| sessionToken | String | Optional | null | Static session token (if provided) |
| credentialGenerator | String | Optional | null | Custom CredentialsGenerator class name (for testing) |
| **serviceEndpoint** | **String** | **Optional** | **null** | **S3-compatible service endpoint URL (NEW)** |

**Validation Rules**:
- Either `awsRoleArn` OR (`accessKey` + `secretKey`) must be provided
- `serviceEndpoint` must be valid URL format if provided
- `serviceEndpoint` null/empty = AWS S3 (backward compatible behavior)
- `serviceEndpoint` format: `http[s]://hostname[:port]`

**Relationships**:
- Created by: `ServerProperties.getS3Configurations()`
- Used by: `AwsCredentialVendor`
- Passed to: `CredentialsGenerator` implementations

**State Transitions**: None (immutable configuration object)

**Example**:
```java
// AWS S3 (existing behavior, no serviceEndpoint)
S3StorageConfig awsConfig = S3StorageConfig.builder()
    .bucketPath("s3://my-aws-bucket")
    .region("us-west-2")
    .awsRoleArn("arn:aws:iam::123456789012:role/UCRole")
    .accessKey("AKIAIOSFODNN7EXAMPLE")
    .secretKey("wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY")
    .build();

// MinIO (new behavior with serviceEndpoint)
S3StorageConfig minioConfig = S3StorageConfig.builder()
    .bucketPath("s3://my-minio-bucket")
    .region("us-east-1")
    .accessKey("minioadmin")
    .secretKey("minioadmin123")
    .serviceEndpoint("https://minio.example.com:9000")
    .build();
```

---

### TemporaryCredentials (API Model)

**Purpose**: Represents temporary credentials returned by Unity Catalog for accessing storage.

**Location**: Generated from `api/all.yaml` → `io.unitycatalog.client.model.TemporaryCredentials`

**Modification**: **NONE** - API remains unchanged per Constitution Principle I & II

**Why no changes**:
- Service endpoint is configuration, not credential data
- Endpoint is passed to Spark via Hadoop configuration properties (internal mechanism)
- Keeps API specification stable and backward compatible
- Clients retrieve endpoint information via `CredPropsUtil` Spark properties, not API response

**Alternative Considered and Rejected**:
Adding `serviceEndpoint` field to TemporaryCredentials response would:
- Break API backward compatibility
- Require API specification changes in `api/all.yaml`
- Force all clients to update even if not using S3-compatible storage
- Violate Unity Catalog Constitution Principle I (API Specification First requires strong justification)

---

## Internal Data Structures

### CredentialContext

**Purpose**: Context object passed through credential vending flow.

**Location**: `server/src/main/java/io/unitycatalog/server/service/credential/CredentialContext.java`

**Modification**: **NONE** - serviceEndpoint flows through S3StorageConfig, not CredentialContext

**Rationale**: CredentialContext represents the requested operation and location, not storage configuration. Service endpoint is a property of the storage configuration, retrieved via `AwsCredentialVendor` from `S3StorageConfig`.

---

### Spark Configuration Properties

**Purpose**: Hadoop configuration properties passed to Spark for S3A filesystem configuration.

**Location**: Generated by `connectors/spark/src/main/scala/io/unitycatalog/spark/auth/CredPropsUtil.java`

**New Property**:

| Property Key | Value | When Set | Purpose |
|--------------|-------|----------|---------|
| `fs.s3a.endpoint` | Service endpoint URL | When S3StorageConfig.serviceEndpoint is non-null | Configures Spark S3A filesystem to use custom S3-compatible endpoint |

**Example**:
```java
Map<String, String> sparkProps = ImmutableMap.builder()
    .put("fs.s3a.access.key", awsCred.getAccessKeyId())
    .put("fs.s3a.secret.key", awsCred.getSecretAccessKey())
    .put("fs.s3a.session.token", awsCred.getSessionToken())
    .put("fs.s3a.endpoint", "https://minio.example.com:9000")  // NEW
    .put("fs.s3a.path.style.access", "true")
    .build();
```

---

## Configuration Storage

### server.properties

**Location**: `etc/conf/server.properties`

**New Configuration Keys**:

| Key Pattern | Type | Example | Description |
|-------------|------|---------|-------------|
| `s3.serviceEndpoint.[index]` | String (URL) | `https://minio.example.com:9000` | Optional S3-compatible service endpoint |

**Full Example**:
```properties
# AWS S3 configuration (index 0)
s3.bucketPath.0=s3://my-aws-bucket
s3.region.0=us-west-2
s3.awsRoleArn.0=arn:aws:iam::123456789012:role/UCRole
s3.accessKey.0=
s3.secretKey.0=
# No serviceEndpoint = AWS S3 (default)

# MinIO configuration (index 1)
s3.bucketPath.1=s3://my-minio-bucket
s3.region.1=us-east-1
s3.awsRoleArn.1=arn:minio:iam::minioadmin:role/UCRole
s3.accessKey.1=minioadmin
s3.secretKey.1=minioadmin123
s3.serviceEndpoint.1=https://minio.example.com:9000

# Wasabi configuration (index 2)
s3.bucketPath.2=s3://my-wasabi-bucket
s3.region.2=us-west-1
s3.accessKey.2=WASABI_ACCESS_KEY
s3.secretKey.2=WASABI_SECRET_KEY
s3.serviceEndpoint.2=https://s3.us-west-1.wasabisys.com
```

**Validation**: URL format validation in `ServerProperties.getS3Configurations()`

---

### Helm Chart Values

**Location**: `helm/values.yaml`

**New Fields**:

```yaml
storage:
  credentials:
    s3:
      - bucketPath: s3://my-minio-bucket
        region: us-east-1
        awsRoleArn: arn:minio:iam::minioadmin:role/UCRole
        credentialsSecretName: minio-creds
        serviceEndpoint: https://minio.example.com:9000  # NEW FIELD
```

**Environment Variable Mapping** (`helm/templates/server/deployment.yaml`):

```yaml
{{- range $index, $config := .Values.storage.credentials.s3 }}
{{- if $config.serviceEndpoint }}
- name: S3_SERVICE_ENDPOINT_{{ $index }}
  value: {{ $config.serviceEndpoint | quote }}
{{- end }}
{{- end }}
```

---

## Data Flow

### Configuration Loading

```
server.properties (or environment variables)
  ↓
ServerProperties.getS3Configurations()
  ↓
Map<String, S3StorageConfig> with serviceEndpoint populated
  ↓
AwsCredentialVendor (stores config map)
```

### Credential Vending

```
Client requests temporary credentials for s3://my-minio-bucket/path
  ↓
CloudCredentialVendor.vendCredential(location, privileges)
  ↓
AwsCredentialVendor.vendAwsCredentials(context)
  ↓
Look up S3StorageConfig by bucket path
  ↓
CredentialsGenerator.generate(context)
  ↓ (if serviceEndpoint != null)
StsClient with endpointOverride = serviceEndpoint
  ↓
MinIO/S3-compatible STS API
  ↓
Temporary credentials (access key, secret, token)
  ↓
TemporaryCredentials API response
```

### Spark Integration

```
UCSingleCatalog.loadTable(ident)
  ↓
Request temporary credentials from Unity Catalog
  ↓
TemporaryCredentials received
  ↓
CredPropsUtil.createTableCredProps(...)
  ↓ (serviceEndpoint retrieved from UC context)
Map<String, String> with fs.s3a.endpoint property
  ↓
Spark CatalogTable storage properties
  ↓
Spark S3A FileSystem uses custom endpoint
  ↓
Read/Write data from/to MinIO
```

---

## Validation Rules Summary

1. **serviceEndpoint format**: Must be valid HTTP/HTTPS URL if provided
2. **serviceEndpoint null handling**: Null/empty = AWS S3 (backward compatible)
3. **Region requirement**: Region still required even with custom endpoint
4. **Credentials requirement**: Either awsRoleArn OR (accessKey + secretKey) must be provided
5. **Endpoint uniqueness**: Multiple configs can use same endpoint (different buckets on same MinIO)
6. **URL scheme**: Must be http:// or https://
7. **Port optional**: https://minio.example.com valid (uses default HTTPS port 443)

---

## Migration Impact

**Database Schema**: No changes  
**API Specification**: No changes  
**Configuration Files**: Additive only (new optional property)  
**Backward Compatibility**: 100% - missing serviceEndpoint = AWS S3 behavior

**Upgrade Path**:
1. Deploy new Unity Catalog version
2. Existing configurations continue to work (AWS S3)
3. Optionally add `s3.serviceEndpoint.[index]` for S3-compatible storage
4. No downtime required
5. No data migration required
